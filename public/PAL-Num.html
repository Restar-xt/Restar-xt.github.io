<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>PAL Num_Total vs Year Interactive</title>
  <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>

  <style>
    body{
      margin:0;
      background:#fff;
      color:#111;
      font-family:"SimHei","Times New Roman",serif;
    }

    /* 顶部标题栏：中文黑体，英文 Times */
    #titleBar{
      padding:14px 18px 8px 18px;
      font-size:24px;
      font-weight:700;
      line-height:1.2;
      background:#fff;
      color:#111;
      border-bottom:1px solid #eee;
      user-select:none;
    }
    #titleBar .cn{ font-family:"SimHei"; }
    #titleBar .non-cn{ font-family:"Times New Roman"; }

    #chart{width:100vw;height:88vh;}

    .hint{
      padding:8px 12px;
      font-size:14px;
      background:#f7f7f8;
      border-bottom:1px solid #e6e6e9;
      color:#333;
      font-family:"SimHei","Times New Roman";
    }

    .cn { font-family:"SimHei"; }
    .non-cn { font-family:"Times New Roman"; }

    #hoverCard{
      position:fixed;
      z-index:9999;
      display:none;
      min-width:260px;
      max-width:420px;
      padding:12px 14px;
      background: rgba(255,255,255,0.60);
      backdrop-filter: blur(18px) saturate(1.35);
      -webkit-backdrop-filter: blur(18px) saturate(1.35);
      border:1px solid rgba(255,255,255,0.9);
      border-radius:14px;
      box-shadow:
        0 12px 32px rgba(0,0,0,0.12),
        0 2px 6px rgba(0,0,0,0.08);
      line-height:1.5;
      font-size:13px;
      color:#111;
      pointer-events:none;
    }
    #hoverCard .title{
      font-size:16px;
      font-weight:700;
      margin-bottom:4px;
      font-family:"Times New Roman";
    }
    #hoverCard .sub{
      font-size:12px;
      margin-bottom:8px;
      color:#444;
      font-family:"Times New Roman";
    }
    #hoverCard .row{ margin:2px 0; }
    #hoverCard .label{ font-weight:700; color:#000; }
    #hoverCard .sec{
      margin-top:7px;
      padding-top:7px;
      border-top:1px dashed rgba(0,0,0,0.12);
    }
  </style>
</head>

<body>
  <!-- 标题栏：PAL/Num_Total Times；中文黑体 -->
  <div id="titleBar">
    <span class="non-cn">PAL</span>
    <span class="cn"> 镜片数</span>
    <span class="non-cn">(Num_Total)</span>
    <span class="cn"> 演变</span>
  </div>

  <div class="hint">鼠标悬停查看详细指标；单击点可跳转 Zotero。</div>
  <div id="chart"></div>
  <div id="hoverCard"></div>

  <script>
  // ============================================================
  // ✅ 防呆：把 "None"/空字符串 自动转成 null
  // ============================================================
  function normalizeValue(v){
    if (v === undefined) return null;
    if (v === null) return null;
    if (typeof v === "string"){
      const s = v.trim();
      if (s === "" || s.toLowerCase() === "none") return null;
      return v;
    }
    return v;
  }

  function normalizePaper(p){
    const out = {...p};
    for (const k in out){
      out[k] = normalizeValue(out[k]);
    }
    return out;
  }

  // ============================================================
  // 1) 文献数据（保持你填入的不变）
  // ============================================================
  let palData = [
    {
      Year: 2007,
      Title: "Design of a panoramic annular lens with a long focal length",
      Authors: "Shuang Niu et al.",
      Venue: "Optics Express",
      FoV: "360°×(50°–100°)",
      Wavelength: "Visible (450–650 nm)",
      EFL_mm: 10.8,
      Fno: 3.7,
      Num_Total: 7,
      Max_Dia_mm: 70,
      Total_Length_mm: 180,
      Distortion_pct: 2,
      MTF_spec: "0.4 @ 100 lp/mm",
      Key_Innovation: "Cemented PAL increases freedom; MDOE relay improves chromatic efficiency",
      Main_Limitation: "Long system length; large diameter",
      Zotero_URI: "zotero://select/items/1_XXXX"
    },
    {
      Year: 2012,
      Title: "Design of a panoramic annular lens with a horizontal symmetric FOV",
      Authors: "Yuan Yao et al.",
      Venue: "AOMATT 2012",
      FoV: "360°×(60°–120°)",
      Wavelength: "Visible (450–650 nm)",
      EFL_mm: 0.3,
      Fno: 2.88,
      Num_Total: 9,
      Max_Dia_mm: 16.6,
      Total_Length_mm: null,
      Distortion_pct: 2,
      MTF_spec: "0.5 @ 70 lp/mm",
      Key_Innovation: "Symmetric horizontal FoV using aspherical correction",
      Main_Limitation: "Limited vertical range",
      Zotero_URI: "zotero://select/items/1_YYYY"
    },
    {
      Year: 2015,
      Title: "Small Distortion Panoramic Annular Lens Design with Q-Type Aspheres",
      Authors: "Xiangdong Zhou et al.",
      Venue: "ACTA OPTICA SINICA",
      FoV: "360°×(30°–110°)",
      Wavelength: "Visible (486–656 nm)",
      EFL_mm: -1.25,
      Fno: 5,
      Num_Total: 7,
      Max_Dia_mm: 16.6,
      Total_Length_mm: 28.7,
      Distortion_pct: 1,
      MTF_spec: "0.5 @ 83 lp/mm",
      Key_Innovation: "Q-type asphere–based distortion control",
      Main_Limitation: "Custom DLL workflow",
      Zotero_URI: "zotero://select/items/1_ZZZZ"
    },
    {
      Year: 2016,
      Title: "Design of high resolution panoramic endoscope imaging system based on freeform surface",
      Authors: "Qun Liu et al.",
      Venue: "Journal of Physics: Conference Series",
      FoV: "360°×(60°–97.5°)",
      Wavelength: "Visible (486–656 nm)",
      EFL_mm: -0.819,
      Fno: 2.8,
      Num_Total: 5,
      Max_Dia_mm: 10,
      Total_Length_mm: "None",
      Distortion_pct: "None",
      MTF_spec: "0.8 @ 70 lp/mm",
      Key_Innovation: "Freeform surface PAL for endoscope; No blind spots: Blind spots achieve high-resolution imaging locally",
      Main_Limitation: "Low-resolution sensor assumption — 设计基于 648×488、7.4 µm 像元 CCD 的截止频率约束，面向更高分辨率/多光谱内窥传感器的可扩展性未评估",
      Zotero_URI: "zotero://select/items/1_AAAA"
    },
    {
      Year: 2016,
      Title: "A novel design of dual-channel optical system of star-tracker based on non-blind area PAL system",
      Authors: "Yujie Luo et al.",
      Venue: "Optics Express",
      FoV: "Ultraviolet band 360°×(30°–90°)+ visible band(0-10°)",
      Wavelength: "Ultraviolet(350-360nm)+Visible (500-800 nm)",
      EFL_mm: 3.61,
      Fno: 2.44,
      Num_Total: 6,
      Max_Dia_mm: "None",
      Total_Length_mm: "None",
      Distortion_pct: 4,
      MTF_spec: "0.225 @ 100 lp/mm",
      Key_Innovation: "Non-blind-area PAL via dichroic filter 基于二向色性滤波片的多通道无盲区",
      Main_Limitation: "Optical complexity & tolerance risk — PAL + 二向色片 + 校正镜组的组合导致系统更复杂、装调/公差敏感性增大，但文中对公差与在轨稳定性讨论有限。",
      Zotero_URI: "zotero://select/items/1_AAAA"
    },
    {
      Year: 2016,
      Title: "Design of a panoramic long-wave infrared athermal system",
      Authors: "Yuan Yao et al.",
      Venue: "Optical Engineering",
      FoV: "360°×(30°–100°)",
      Wavelength: "Long-wave infrared band (8-13um)",
      EFL_mm: 3.4,
      Fno: 1.15,
      Num_Total: 4,
      Max_Dia_mm: "None",
      Total_Length_mm: 175,
      Distortion_pct: 7,
      MTF_spec: "0.2 @ 20 lp/mm",
      Key_Innovation: "Wide-band 8–12 μm thermal imaging 长波红外成像; Passive optical athermalization design 组合材料实现消热差",
      Main_Limitation: "Lengthy mechanical package 光学总长过长; Potential thermal stray-light sensitivity 长波红外下杂散光抑制方法未阐明",
      Zotero_URI: "zotero://select/items/1_AAAA"
    },
    {
      Year: 2022,
      Title: "Compact and lightweight panoramic annular lens for computer vision tasks",
      Authors: "Shaohua Gao et al.",
      Venue: "Optics Express",
      FoV: "360°×(25°–100°)",
      Wavelength: "Visible (486–656 nm)",
      EFL_mm: -1.17,
      Fno: 5.5,
      Num_Total: 3,
      Max_Dia_mm: "None",
      Total_Length_mm: 29.2,
      Distortion_pct: 4.5,
      MTF_spec: "0.1 @ 125 lp/mm",
      Key_Innovation: "Focal power distribution theory 基于匹兹凡场曲校正的光焦度分配理论; Optics-computational co-design for vision tasks 光学设计+配套算法实现cv任务",
      Main_Limitation: "Optical quality near physical limit 过分追求小型化，镜片数量太少，过分依靠算法校正; Heavy reliance on learning-based restoration 泛化程度较低",
      Zotero_URI: "zotero://select/items/1_AAAA"
    },
    {
      Year: 2022,
      Title: "Design of a compact infrared panoramic optical system for unmanned aerial vehicles",
      Authors: "Yingzhe Yang et al.",
      Venue: "Optical Design and Testing XII",
      FoV: "360°×(30°–100°)",
      Wavelength: "Infrared",
      EFL_mm: 2.2,
      Fno: 3,
      Num_Total: 3,
      Max_Dia_mm: 72,
      Total_Length_mm: 51.6,
      Distortion_pct: 2,
      MTF_spec: "None",
      Key_Innovation: "Three-element compact IR PAL 三片式简化红外 PAL 结构，实现紧凑化全景成像; Optics-computational co-design for vision tasks 光学设计+配套算法实现cv任务",
      Main_Limitation: "Simulation-heavy validation 主要是仿真，缺少公差等分析; Unclear athermal/stray-light treatment 红外波段消杂光/幅射光手段未阐明，和yuan yao. etl一篇一样",
      Zotero_URI: "zotero://select/items/1_AAAA"
    },
    {
      Year: 2022,
      Title: "High-performance compact athermal panoramic annular lens design with separated radial optical power",
      Authors: "Chengxi Zhu et al.",
      Venue: "Applied Optics",
      FoV: "360°×(40°–100°)",
      Wavelength: "Visible (486–656 nm)",
      EFL_mm: 1.001,
      Fno: 2.2,
      Num_Total: 6,
      Max_Dia_mm: "None",
      Total_Length_mm: 40,
      Distortion_pct: 2.5,
      MTF_spec: "0.5 @ 200lp/mm",
      Key_Innovation: "Free-form surfaces for aberration correction and field optimization — 引入多个自由曲面改善像差、校正场曲;High imaging performance — MTF 在 0.5@200 lp/mm 以上、畸变小于2.5%",
      Main_Limitation: "High optical complexity & manufacturing cost 多自由曲面、径向功率分离设计、消热结构带来制造加工难度和成本上升，实际可量产性可能受限",
      Zotero_URI: "zotero://select/items/1_AAAA"
    },
    {
      Year: 2023,
      Title: "Ultra-wide angle panoramic imaging system based on a multiplexed reflective surface",
      Authors: "Fang Ke et al.",
      Venue: "Applied Optics",
      FoV: "360°×(35°–90°)",
      Wavelength: "Visible (486–656 nm)",
      EFL_mm: -0.7,
      Fno: 4.0,
      Num_Total: 9,
      Max_Dia_mm: "None",
      Total_Length_mm: 133.2,
      Distortion_pct: 2.89,
      MTF_spec: "0.556 @ 125lp/mm",
      Key_Innovation: "Multiplexed reflective surface in PHU 在PHU中引入“复用反射面”，完成多路反射取景;Ultra-wide FoV panoramic system 提出了覆盖极端视场角的新思路",
      Main_Limitation: "Higher alignment sensitivity 多反射复用结构对反射面位置/角度更敏感",
      Zotero_URI: "zotero://select/items/1_AAAA"
    },
    {
      Year: 2023,
      Title: "Ultra-wide angle panoramic imaging system based on a multiplexed reflective surface",
      Authors: "Fang Ke et al.",
      Venue: "Applied Optics",
      FoV: "360°×(90°–120°)",
      Wavelength: "Visible (486–656 nm)",
      EFL_mm: -1.26,
      Fno: 4.0,
      Num_Total: 9,
      Max_Dia_mm: "None",
      Total_Length_mm: 133.2,
      Distortion_pct: 21.38,
      MTF_spec: "0.307 @ 125lp/mm",
      Key_Innovation: "Multiplexed reflective surface in PHU 在PHU中引入“复用反射面”，完成多路反射取景;Ultra-wide FoV panoramic system 提出了覆盖极端视场角的新思路",
      Main_Limitation: "Higher alignment sensitivity 多反射复用结构对反射面位置/角度更敏感",
      Zotero_URI: "zotero://select/items/1_AAAA"
    },
    {
      Year: 2023,
      Title: "Design of a compact triple-channel panoramic stereo imaging system",
      Authors: "Ning Pan et al.",
      Venue: "Optics Express",
      FoV: "360°×(0°–40°)",
      Wavelength: "Visible (486–656 nm)",
      EFL_mm: 0.284,
      Fno: 4.707,
      Num_Total: 8,
      Max_Dia_mm: "None",
      Total_Length_mm: 81.114,
      Distortion_pct: 9.933,
      MTF_spec: "0.147 @ 147lp/mm",
      Key_Innovation: "Polarization-enabled third channel 在第一反射面引入偏振技术，额外生成第三通道用于立体视觉",
      Main_Limitation: "Polarization loss / SNR penalty — 偏振分光与多次反射带来通光效率下降; Higher alignment & coating sensitivity",
      Zotero_URI: "zotero://select/items/1_AAAA"
    },
    {
      Year: 2023,
      Title: "Design of a compact triple-channel panoramic stereo imaging system",
      Authors: "Ning Pan et al.",
      Venue: "Optics Express",
      FoV: "360°×(40°–105°)",
      Wavelength: "Visible (486–656 nm)",
      EFL_mm: 0.269,
      Fno: 4.688,
      Num_Total: 8,
      Max_Dia_mm: "None",
      Total_Length_mm: 65.949,
      Distortion_pct: 9.873,
      MTF_spec: "0.428 @ 147lp/mm",
      Key_Innovation: "Polarization-enabled third channel 在第一反射面引入偏振技术，额外生成第三通道用于立体视觉",
      Main_Limitation: "Polarization loss / SNR penalty — 偏振分光与多次反射带来通光效率下降; Higher alignment & coating sensitivity",
      Zotero_URI: "zotero://select/items/1_AAAA"
    },
    {
      Year: 2023,
      Title: "Design of a compact triple-channel panoramic stereo imaging system",
      Authors: "Ning Pan et al.",
      Venue: "Optics Express",
      FoV: "360°×(20°–50°)",
      Wavelength: "Visible (486–656 nm)",
      EFL_mm: 1.474,
      Fno: 4.688,
      Num_Total: 8,
      Max_Dia_mm: "None",
      Total_Length_mm: 65.949,
      Distortion_pct: 6.987,
      MTF_spec: "0.132 @ 147lp/mm",
      Key_Innovation: "Polarization-enabled third channel 在第一反射面引入偏振技术，额外生成第三通道用于立体视觉",
      Main_Limitation: "Polarization loss / SNR penalty — 偏振分光与多次反射带来通光效率下降; Higher alignment & coating sensitivity",
      Zotero_URI: "zotero://select/items/1_AAAA"
    },
    {
      Year: 2023,
      Title: "Design of a panoramic annular lens system with an ultra-wide angle via an annular gaussian radial basis function freeform surface",
      Authors: "Ning Pan et al.",
      Venue: "Optics Express",
      FoV: "360°×(30°–125°)",
      Wavelength: "Visible (486–656 nm)",
      EFL_mm: -0.65,
      Fno: 2.5,
      Num_Total: 7,
      Max_Dia_mm: "None",
      Total_Length_mm: 28.63,
      Distortion_pct: 3,
      MTF_spec: "0.5 @ 100lp/mm",
      Key_Innovation: "Annular Gaussian RBF freeform surface",
      Main_Limitation: "Model complexity & optimization burden RBF局部自由曲面参数量更大、优化维度更高，对设计收敛与全局最优搜索带来负担",
      Zotero_URI: "zotero://select/items/1_AAAA"
    },
    {
      Year: 2024,
      Title: "Design, analysis, and manufacturing of a glass-plastic hybrid minimalist aspheric panoramic annular lens",
      Authors: "Shaohua Gao et al.",
      Venue: "Optics & Laser Technology",
      FoV: "360°×(35°–110°)",
      Wavelength: "Visible (486–656 nm)",
      EFL_mm: -0.97,
      Fno: 4.5,
      Num_Total: 4,
      Max_Dia_mm: "None",
      Total_Length_mm: 17.4,
      Distortion_pct: 3.5,
      MTF_spec: "0.47 @ 133lp/mm",
      Key_Innovation: "Glass–plastic hybrid minimalist ASPAL; Four-element high-performance; Small-batch manufacturable workflow",
      Main_Limitation: "Negative EFL ultra-short focal design constraints",
      Zotero_URI: "zotero://select/items/1_AAAA"
    },
    {
      Year: 2024,
      Title: "Design, analysis, and manufacturing of a glass-plastic hybrid minimalist aspheric panoramic annular lens",
      Authors: "Shaohua Gao et al.",
      Venue: "Optics & Laser Technology",
      FoV: "360°×(35°–110°)",
      Wavelength: "Visible (486–656 nm)",
      EFL_mm: -0.97,
      Fno: 4.5,
      Num_Total: 4,
      Max_Dia_mm: "None",
      Total_Length_mm: 17.4,
      Distortion_pct: 3.5,
      MTF_spec: "0.47 @ 133lp/mm",
      Key_Innovation: "Glass–plastic hybrid minimalist ASPAL; Four-element high-performance; Small-batch manufacturable workflow",
      Main_Limitation: "Negative EFL ultra-short focal design constraints",
      Zotero_URI: "zotero://select/items/1_AAAA"
    },
    {
      Year: 2025,
      Title: "Design of a dual-channel panoramic annular lens for imaging and time-of-flight based on freeform surface prisms",
      Authors: "Ning Pan et al.",
      Venue: "Optics Express",
      FoV: "360°×(40°–100°)",
      Wavelength: "940nm",
      EFL_mm: -1.399,
      Fno: 2.8,
      Num_Total: 2,
      Max_Dia_mm: "None",
      Total_Length_mm: 51.456,
      Distortion_pct: 3.407,
      MTF_spec: "0.494 @ 50lp/mm",
      Key_Innovation: "Dual-channel PAL for imaging + TOF in one lens; Freeform surface prisms replacing relay group",
      Main_Limitation: "Channel throughput/SNR trade-off",
      Zotero_URI: "zotero://select/items/1_AAAA"
    },
    {
      Year: 2025,
      Title: "Design of a dual-channel panoramic annular lens for imaging and time-of-flight based on freeform surface prisms",
      Authors: "Ning Pan et al.",
      Venue: "Optics Express",
      FoV: "360°×(40°–100°)",
      Wavelength: "Visible (486–656 nm)",
      EFL_mm: -1.500,
      Fno: 2.977,
      Num_Total: 2,
      Max_Dia_mm: "None",
      Total_Length_mm: 51.456,
      Distortion_pct: 3.402,
      MTF_spec: "0.3 @ 144lp/mm",
      Key_Innovation: "Dual-channel PAL for imaging + TOF in one lens; Freeform surface prisms replacing relay group",
      Main_Limitation: "Channel throughput/SNR trade-off",
      Zotero_URI: "zotero://select/items/1_AAAA"
    },
    {
      Year: 2025,
      Title: "Design of a multidimensional information perception panoramic imaging system without a central blind area and front lens group",
      Authors: "Ruoyan Wei et al.",
      Venue: "Applied Optics",
      FoV: "360°×(22°–60°)",
      Wavelength: "Visible (486–656 nm)",
      EFL_mm: 1.455,
      Fno: 2.49,
      Num_Total: 9,
      Max_Dia_mm: "None",
      Total_Length_mm: 99.95,
      Distortion_pct: 0.119,
      MTF_spec: "0.318 @ 172lp/mm",
      Key_Innovation: "Triple-channel non-blind-area; Dual-band + dual-polarization co-imaging",
      Main_Limitation: "Channel complexity without front group",
      Zotero_URI: "zotero://select/items/1_AAAA"
    },
    {
      Year: 2025,
      Title: "Design of a multidimensional information perception panoramic imaging system without a central blind area and front lens group",
      Authors: "Ruoyan Wei et al.",
      Venue: "Applied Optics",
      FoV: "360°×(60°–96°)",
      Wavelength: "Visible (486–656 nm)",
      EFL_mm: 0.317,
      Fno: 2.49,
      Num_Total: 9,
      Max_Dia_mm: "None",
      Total_Length_mm: 99.95,
      Distortion_pct: 7.481,
      MTF_spec: "0.326 @ 172lp/mm",
      Key_Innovation: "Triple-channel non-blind-area; Dual-band + dual-polarization co-imaging",
      Main_Limitation: "Channel complexity without front group",
      Zotero_URI: "zotero://select/items/1_AAAA"
    },
    {
      Year: 2025,
      Title: "Design of a multidimensional information perception panoramic imaging system without a central blind area and front lens group",
      Authors: "Ruoyan Wei et al.",
      Venue: "Applied Optics",
      FoV: "360°×(60°–96°)",
      Wavelength: "800–900 nm",
      EFL_mm: 1.269,
      Fno: 2.5,
      Num_Total: 9,
      Max_Dia_mm: "None",
      Total_Length_mm: 99.95,
      Distortion_pct: 0.06,
      MTF_spec: "0.309 @ 172lp/mm",
      Key_Innovation: "Triple-channel non-blind-area; Dual-band + dual-polarization co-imaging",
      Main_Limitation: "Channel complexity without front group",
      Zotero_URI: "zotero://select/items/1_AAAA"
    }
    // ...继续补全到 36 篇
  ];

  palData = palData.map(normalizePaper);

  // ============================================================
  // 2) 散点：Y 改为 Num_Total
  // ============================================================
  const years = palData.map(d => d.Year);
  const nums  = palData.map(d => d.Num_Total);  // ✅ 镜片数

  const customdata = palData.map(d => ([
    d.Title, d.Authors, d.Venue, d.FoV, d.Wavelength,
    d.Fno, d.Num_Total, d.Max_Dia_mm, d.Total_Length_mm,
    d.Distortion_pct, d.MTF_spec,
    d.Key_Innovation, d.Main_Limitation, d.Zotero_URI
  ]));

  const colorPool = [
    "#1f77b4","#ff7f0e","#2ca02c","#d62728","#9467bd",
    "#8c564b","#e377c2","#7f7f7f","#bcbd22","#17becf",
    "#393b79","#637939","#8c6d31","#843c39","#7b4173",
    "#3182bd","#e6550d","#31a354","#756bb1","#636363",
    "#9c9ede","#cedb9c","#e7cb94","#e7969c","#de9ed6",
    "#6baed6","#fd8d3c","#74c476","#9e9ac8","#969696",
    "#c6dbef","#fdd0a2","#c7e9c0","#dadaeb","#d9d9d9"
  ];

  const trace = {
    x: years,
    y: nums,
    mode: "markers",
    type: "scatter",
    customdata: customdata,
    hoverinfo: "none",
    marker: {
      size: 12,
      color: years.map((_, i) => colorPool[i % colorPool.length]),
      opacity: 0.95,
      line: { width: 1.2, color: "white" }
    }
  };

  const layout = {
    paper_bgcolor: "white",
    plot_bgcolor: "white",
    xaxis: {
      title: { text: "Year", font: { family:"Times New Roman", size:16 } },
      tickfont: { family:"Times New Roman" },
      gridcolor: "#e6e6e6"
    },
    yaxis: {
      title: { text: "Num_Total (lenses)", font: { family:"Times New Roman", size:16 } },
      tickfont: { family:"Times New Roman" },
      gridcolor: "#e6e6e6",
      rangemode: "tozero"
    },
    hovermode: "closest",
    hoverdistance: 20,
    margin: { l:70, r:30, t:20, b:60 }
  };

  Plotly.newPlot("chart", [trace], layout, { responsive:true });

  // ============================================================
  // 3) Hover 卡片：把原“焦距 EFL”改为“镜片数 Num_Total”
  // ============================================================
  const card = document.getElementById("hoverCard");
  const chartDiv = document.getElementById("chart");

  function show(v, suffix=""){
    v = normalizeValue(v);
    if (v === null) return `<span class="non-cn">None</span>`;
    return `<span class="non-cn">${v}${suffix}</span>`;
  }
  function en(t){ return `<span class="non-cn">${t}</span>`; }

  function buildCardHTML(pt){
    const d = pt.customdata;
    return `
      <div class="title non-cn">${d[0] ?? "None"}</div>
      <div class="sub non-cn">${d[1] ?? "None"} — ${d[2] ?? "None"}</div>

      <div class="row"><span class="cn label">年份：</span>${show(pt.x)}</div>
      <div class="row"><span class="cn label">镜片数 ${en("Num_Total")}：</span>${show(pt.y)}</div>
      <div class="row"><span class="cn label">视场：</span>${show(d[3])}</div>
      <div class="row"><span class="cn label">工作波段：</span>${show(d[4])}</div>
      <div class="row"><span class="cn label">${en("F/#")}：</span>${show(d[5])}</div>
      <div class="row"><span class="cn label">最大直径：</span>${show(d[7]," mm")}</div>
      <div class="row"><span class="cn label">总长：</span>${show(d[8]," mm")}</div>
      <div class="row"><span class="cn label">畸变：</span>${show(d[9],"%")}</div>
      <div class="row"><span class="cn label">${en("MTF")}：</span>${show(d[10])}</div>

      <div class="sec">
        <div class="row"><span class='cn label'>创新点：</span></div>
        <div class="row non-cn">${show(d[11])}</div>
      </div>

      <div class="sec">
        <div class="row"><span class='cn label'>局限性：</span></div>
        <div class="row non-cn">${show(d[12])}</div>
      </div>
    `;
  }

  function positionCard(cx, cy){
    const offset = 14, margin = 8;
    let left = cx + offset, top = cy + offset;

    card.style.display = "block";
    card.style.left = left+"px";
    card.style.top  = top+"px";

    const r = card.getBoundingClientRect();
    const vw = window.innerWidth, vh = window.innerHeight;

    if(r.right > vw - margin) left = cx - r.width - offset;
    if(left < margin) left = margin;

    if(r.bottom > vh - margin) top = cy - r.height - offset;
    if(top < margin) top = margin;

    card.style.left = left+"px";
    card.style.top  = top+"px";
  }

  chartDiv.on("plotly_hover", e=>{
    const pt = e.points[0];
    card.innerHTML = buildCardHTML(pt);
    positionCard(e.event.clientX, e.event.clientY);
  });

  chartDiv.on("plotly_unhover", ()=> card.style.display="none");

  chartDiv.addEventListener("mousemove", e=>{
    if(card.style.display==="block"){
      positionCard(e.clientX, e.clientY);
    }
  });

  chartDiv.on("plotly_click", e=>{
    const uri = e.points[0].customdata[13];
    if(uri && uri.startsWith("zotero://")) window.location.href = uri;
  });

  window.addEventListener("resize", ()=>{
    if(card.style.display==="block"){
      const r = card.getBoundingClientRect();
      positionCard(r.left, r.top);
    }
  });
  </script>
</body>
</html>
